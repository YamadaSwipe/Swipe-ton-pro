<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Career Tinder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Login Section -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white rounded-lg shadow-md p-6">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Administration</h1>
                <p class="text-gray-600 mt-2">Career Tinder - Panneau d'administration</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="admin@example.com">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                    <input type="password" id="password" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Mot de passe">
                </div>
                
                <button type="submit" id="loginBtn"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Se connecter
                </button>
            </form>
            
            <div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
            </div>
            
            <div class="mt-6 text-center text-sm text-gray-600">
                <p>Compte de test :</p>
                <p class="text-xs">Email: admin@careertinder.com</p>
                <p class="text-xs">Mot de passe: admin123</p>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <h1 class="text-3xl font-bold text-gray-900">Dashboard Admin</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="adminInfo" class="text-sm text-gray-600"></span>
                        <button onclick="logout()" 
                                class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                            Déconnexion
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Navigation -->
            <nav class="mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8">
                        <button onclick="showTab('dashboard')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                            Dashboard
                        </button>
                        <button onclick="showTab('users')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Utilisateurs
                        </button>
                        <button onclick="showTab('admins')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Admins
                        </button>
                        <button onclick="showTab('reports')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Signalements
                        </button>
                    </nav>
                </div>
            </nav>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-700">Utilisateurs Total</h3>
                        <p id="totalUsers" class="text-3xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-700">Professionnels</h3>
                        <p id="totalProfessionals" class="text-3xl font-bold text-green-600">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-700">Admins</h3>
                        <p id="totalAdmins" class="text-3xl font-bold text-purple-600">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-700">Signalements en attente</h3>
                        <p id="pendingReports" class="text-3xl font-bold text-red-600">-</p>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Gestion des utilisateurs</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-2 text-left">Nom</th>
                                        <th class="px-4 py-2 text-left">Email</th>
                                        <th class="px-4 py-2 text-left">Type</th>
                                        <th class="px-4 py-2 text-left">Statut</th>
                                        <th class="px-4 py-2 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admins Tab -->
            <div id="adminsTab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Administrateurs</h3>
                            <button onclick="showInviteModal()" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                Inviter Admin
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-2 text-left">Nom</th>
                                        <th class="px-4 py-2 text-left">Email</th>
                                        <th class="px-4 py-2 text-left">Rôle</th>
                                        <th class="px-4 py-2 text-left">Dernière connexion</th>
                                        <th class="px-4 py-2 text-left">Statut</th>
                                    </tr>
                                </thead>
                                <tbody id="adminsTableBody">
                                    <!-- Admins will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Signalements</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-2 text-left">Raison</th>
                                        <th class="px-4 py-2 text-left">Description</th>
                                        <th class="px-4 py-2 text-left">Statut</th>
                                        <th class="px-4 py-2 text-left">Date</th>
                                        <th class="px-4 py-2 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTableBody">
                                    <!-- Reports will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div id="inviteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Inviter un administrateur</h3>
                <button onclick="closeInviteModal()" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>
            
            <form id="inviteForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="inviteEmail" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rôle</label>
                    <select id="inviteRole" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="moderator">Modérateur</option>
                        <option value="admin">Admin</option>
                        <option value="super_admin">Super Admin</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeInviteModal()" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                        Annuler
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                        Inviter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin + '/api';
        let authToken = null;
        let currentAdmin = null;

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            loginBtn.textContent = 'Connexion...';
            loginBtn.disabled = true;
            loginError.classList.add('hidden');
            
            try {
                const response = await axios.post(`${API_BASE}/admin/login`, {
                    email: email,
                    password: password
                });
                
                authToken = response.data.access_token;
                currentAdmin = response.data.admin;
                
                // Store in localStorage
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentAdmin', JSON.stringify(currentAdmin));
                
                showDashboard();
                
            } catch (error) {
                loginError.textContent = error.response?.data?.detail || 'Erreur de connexion';
                loginError.classList.remove('hidden');
            } finally {
                loginBtn.textContent = 'Se connecter';
                loginBtn.disabled = false;
            }
        });

        // Check for existing session
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('authToken');
            const savedAdmin = localStorage.getItem('currentAdmin');
            
            if (savedToken && savedAdmin) {
                authToken = savedToken;
                currentAdmin = JSON.parse(savedAdmin);
                showDashboard();
            }
        });

        // Show dashboard
        function showDashboard() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('adminInfo').textContent = 
                `Connecté en tant que ${currentAdmin.name} (${currentAdmin.role})`;
            
            loadStats();
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentAdmin');
            authToken = null;
            currentAdmin = null;
            
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            
            // Reset form
            document.getElementById('loginForm').reset();
        }

        // API request helper
        async function apiRequest(url, options = {}) {
            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            };
            
            try {
                return await axios(url, config);
            } catch (error) {
                if (error.response?.status === 401) {
                    logout();
                    throw new Error('Session expirée');
                }
                throw error;
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await apiRequest(`${API_BASE}/admin/stats`);
                const stats = response.data;
                
                document.getElementById('totalUsers').textContent = stats.total_users || 0;
                document.getElementById('totalProfessionals').textContent = stats.total_professionals || 0;
                document.getElementById('totalAdmins').textContent = stats.total_admins || 0;
                document.getElementById('pendingReports').textContent = stats.pending_reports || 0;
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
            }
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-blue-500', 'text-blue-600');
            
            // Load data for the tab
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'admins') {
                loadAdmins();
            } else if (tabName === 'reports') {
                loadReports();
            } else if (tabName === 'dashboard') {
                loadStats();
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await apiRequest(`${API_BASE}/admin/users`);
                const users = response.data.users || [];
                
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = users.map(user => `
                    <tr class="border-b">
                        <td class="px-4 py-2">${user.name}</td>
                        <td class="px-4 py-2">${user.email}</td>
                        <td class="px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs ${user.is_professional ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                ${user.is_professional ? 'Professionnel' : 'Utilisateur'}
                            </span>
                        </td>
                        <td class="px-4 py-2">
                            <select onchange="updateUserStatus('${user.id}', this.value)" class="border rounded px-2 py-1 text-sm">
                                <option value="active" ${user.status === 'active' ? 'selected' : ''}>Actif</option>
                                <option value="suspended" ${user.status === 'suspended' ? 'selected' : ''}>Suspendu</option>
                                <option value="banned" ${user.status === 'banned' ? 'selected' : ''}>Banni</option>
                            </select>
                        </td>
                        <td class="px-4 py-2">
                            <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800 text-sm">
                                Supprimer
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erreur lors du chargement des utilisateurs:', error);
            }
        }

        // Load admins
        async function loadAdmins() {
            try {
                const response = await apiRequest(`${API_BASE}/admin/list`);
                const admins = response.data || [];
                
                const tbody = document.getElementById('adminsTableBody');
                tbody.innerHTML = admins.map(admin => `
                    <tr class="border-b">
                        <td class="px-4 py-2">${admin.name}</td>
                        <td class="px-4 py-2">${admin.email}</td>
                        <td class="px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs ${
                                admin.role === 'super_admin' ? 'bg-red-100 text-red-800' :
                                admin.role === 'admin' ? 'bg-blue-100 text-blue-800' :
                                'bg-green-100 text-green-800'
                            }">
                                ${admin.role === 'super_admin' ? 'Super Admin' :
                                  admin.role === 'admin' ? 'Admin' : 'Modérateur'}
                            </span>
                        </td>
                        <td class="px-4 py-2">
                            ${admin.last_login ? new Date(admin.last_login).toLocaleDateString() : 'Jamais'}
                        </td>
                        <td class="px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs ${admin.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${admin.is_active ? 'Actif' : 'Inactif'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erreur lors du chargement des admins:', error);
            }
        }

        // Load reports
        async function loadReports() {
            try {
                const response = await apiRequest(`${API_BASE}/admin/reports`);
                const reports = response.data.reports || [];
                
                const tbody = document.getElementById('reportsTableBody');
                tbody.innerHTML = reports.map(report => `
                    <tr class="border-b">
                        <td class="px-4 py-2">${report.reason}</td>
                        <td class="px-4 py-2">${report.description}</td>
                        <td class="px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs ${report.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                ${report.status === 'pending' ? 'En attente' : 'Résolu'}
                            </span>
                        </td>
                        <td class="px-4 py-2">${new Date(report.created_at).toLocaleDateString()}</td>
                        <td class="px-4 py-2">
                            ${report.status === 'pending' ? 
                                `<button onclick="resolveReport('${report.id}')" class="text-green-600 hover:text-green-800 text-sm">Résoudre</button>` :
                                '-'
                            }
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erreur lors du chargement des signalements:', error);
            }
        }

        // User management functions
        async function updateUserStatus(userId, newStatus) {
            try {
                await apiRequest(`${API_BASE}/admin/users/${userId}`, {
                    method: 'PUT',
                    data: { status: newStatus }
                });
                console.log('Statut utilisateur mis à jour');
            } catch (error) {
                console.error('Erreur lors de la mise à jour du statut:', error);
                alert('Erreur lors de la mise à jour du statut');
            }
        }

        async function deleteUser(userId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
                try {
                    await apiRequest(`${API_BASE}/admin/users/${userId}`, {
                        method: 'DELETE'
                    });
                    loadUsers(); // Reload the list
                } catch (error) {
                    console.error('Erreur lors de la suppression:', error);
                    alert('Erreur lors de la suppression');
                }
            }
        }

        // Invite modal
        function showInviteModal() {
            document.getElementById('inviteModal').classList.remove('hidden');
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').classList.add('hidden');
            document.getElementById('inviteForm').reset();
        }

        // Invite admin
        document.getElementById('inviteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('inviteEmail').value;
            const role = document.getElementById('inviteRole').value;
            
            try {
                await apiRequest(`${API_BASE}/admin/invite`, {
                    method: 'POST',
                    data: {
                        email: email,
                        role: role,
                        permissions: role === 'super_admin' ? 
                            ["invite_admins", "view_admins", "view_invitations", "view_users", "modify_users", "delete_users", "view_stats", "view_reports", "resolve_reports"] :
                            role === 'admin' ? 
                            ["view_users", "modify_users", "view_stats", "view_reports", "resolve_reports"] :
                            ["view_reports", "resolve_reports"]
                    }
                });
                
                alert('Invitation envoyée avec succès !');
                closeInviteModal();
                loadAdmins(); // Reload the list
            } catch (error) {
                console.error('Erreur lors de l\'invitation:', error);
                alert('Erreur lors de l\'invitation: ' + (error.response?.data?.detail || error.message));
            }
        });

        // Resolve report
        async function resolveReport(reportId) {
            try {
                await apiRequest(`${API_BASE}/admin/reports/${reportId}/resolve`, {
                    method: 'PUT'
                });
                loadReports(); // Reload the list
            } catch (error) {
                console.error('Erreur lors de la résolution:', error);
                alert('Erreur lors de la résolution du signalement');
            }
        }
    </script>
</body>
</html>